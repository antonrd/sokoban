<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sokoban Classic</title>
    <style>
        body {
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #333;
            color: #eee;
            margin: 0;
            padding: 20px;
            padding-bottom: 150px; /* Add padding for D-pad on mobile */
        }
        .controls {
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
            justify-content: center;
        }
        select, button, .dpad-button { /* Added .dpad-button for shared styling */
            padding: 8px 12px;
            font-size: 16px;
            background-color: #555;
            color: #eee;
            border: 1px solid #777;
            border-radius: 4px;
            cursor: pointer;
            user-select: none; /* Prevent text selection on buttons */
            -webkit-user-select: none;
        }
        select:hover, button:hover, .dpad-button:hover {
            background-color: #666;
        }
        select:active, button:active, .dpad-button:active {
            background-color: #777; /* Visual feedback for press */
        }
        #moveCounter {
            font-size: 16px;
            padding: 8px 12px;
            background-color: #444;
            border: 1px solid #666;
            border-radius: 4px;
        }
        #gameBoard {
            display: grid;
            border: 2px solid #777;
            background-color: #222;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            margin-bottom: 20px; /* Space before D-pad */
        }
        .cell {
            width: 30px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
        }
        .wall { background-color: #4a4a4a; color: #4a4a4a; }
        .floor { background-color: #ddd; color: #ddd; }
        .player { background-color: #0b6684; }
        .box { background-color: #583506; }
        .target { background-color: #90ee90; }
        .box-on-target { background-color: #ffd700; }
        .player-on-target { background-color: #87cefa; }

        #message {
            margin-top: 10px; /* Reduced margin as D-pad is below board */
            font-size: 1.2em;
            color: #ffeb3b;
            min-height: 1.5em;
            text-align: center;
        }

        /* D-Pad Styles */
        #dpadControls {
            display: grid;
            grid-template-columns: repeat(3, 60px); /* Button size */
            grid-template-rows: repeat(3, 60px);    /* Button size */
            gap: 5px;
            justify-content: center; /* Center the D-pad */
            margin-top: 15px;
        }
        .dpad-button {
            font-size: 28px; /* Larger font for arrows */
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #606060;
            border: 2px solid #888;
            border-radius: 10px;
        }
        #dpadUp { grid-column: 2; grid-row: 1; }
        #dpadLeft { grid-column: 1; grid-row: 2; }
        #dpadCenter { /* Optional: could be an empty div or another button */
            grid-column: 2; grid-row: 2;
            background-color: #444; /* Darker center */
            border-radius: 50%; /* Make it round */
        }
        #dpadRight { grid-column: 3; grid-row: 2; }
        #dpadDown { grid-column: 2; grid-row: 3; }

    </style>
</head>
<body>
    <h1>Sokoban Classic</h1>

    <div class="controls">
        <label for="levelSelect">Select Level:</label>
        <select id="levelSelect"></select>
        <button id="resetButton">Reset Level</button>
        <button id="undoButton">Undo Move</button>
        <span id="moveCounter">Moves: 0</span>
    </div>

    <div id="gameBoard"></div>
    <div id="message">Use arrow keys, W/A/S/D, or on-screen D-pad to move.</div>

    <!-- D-Pad Controls -->
    <div id="dpadControls">
        <div></div> <button id="dpadUp" class="dpad-button">↑</button> <div></div>
        <button id="dpadLeft" class="dpad-button">←</button> <div id="dpadCenter"></div> <button id="dpadRight" class="dpad-button">→</button>
        <div></div> <button id="dpadDown" class="dpad-button">↓</button> <div></div>
    </div>


    <script>
        // --- Game Data ---
        const levels = [
            {
                name: "Classic 1: First Steps", // 1 box, 1 target
                layout: [
                    "  #####",
                    "  #@$.#",
                    "  #####"
                ]
            },
            {
                name: "Classic 2: Simple Push", // 2 boxes, 2 targets
                layout: [
                    "#####",
                    "#@$.#",
                    "# $.#",
                    "#####"
                ]
            },
            {
                name: "Level 1",
                layout: [
                "    #####",
                "    #   #",
                "    #$  #",
                "  ###  $##",
                "  #  $ $ #",
                "### # ## #   ######",
                "#   # ## #####  ..#",
                "# $  $          ..#",
                "##### ### #@##  ..#",
                "    #     #########",
                "    ####### "
                ]
            },
            {
                name: "Level 2",
                layout: [
                "############",
                "#..  #     ###",
                "#..  # $  $  #",
                "#..  #$####  #",
                "#..    @ ##  #",
                "#..  # #  $ ##",
                "###### ##$ $ #",
                "  # $  $ $ $ #",
                "  #    #     #",
                "  ############ "
                ]
            },
            {
                name: "Level 3",
                layout: [
                "        ########",
                "        #     @#",
                "        # $#$ ##",
                "        # $  $#",
                "        ##$ $ #",
                "######### $ # ###",
                "#....  ## $  $  #",
                "##...    $  $   #",
                "#....  ##########",
                "######## "
                ]
            },
            {
                name: "Level 4",
                layout: [
                "           ########",
                "           #  ....#",
                "############  ....#",
                "#    #  $ $   ....#",
                "# $$$#$  $ #  ....#",
                "#  $     $ #  ....#",
                "# $$ #$ $ $########",
                "#  $ #     #",
                "## #########",
                "#    #    ##",
                "#     $   ##",
                "#  $$#$$  @#",
                "#    #    ##",
                "########### "
                ]
            },
            {
                name: "Level 5",
                layout: [
                "        #####",
                "        #   #####",
                "        # #$##  #",
                "        #     $ #",
                "######### ###   #",
                "#....  ## $  $###",
                "#....    $ $$ ##",
                "#....  ##$  $ @#",
                "#########  $  ##",
                "        # $ $  #",
                "        ### ## #",
                "          #    #",
                "          ###### "
                ]
            },
            {
                name: "Level 6",
                layout: [
                "######  ###",
                "#..  # ##@##",
                "#..  ###   #",
                "#..     $$ #",
                "#..  # # $ #",
                "#..### # $ #",
                "#### $ #$  #",
                "   #  $# $ #",
                "   # $  $  #",
                "   #  ##   #",
                "   ######### "
                ]
            },
            {
                name: "Level 7",
                layout: [
                "       #####",
                " #######   ##",
                "## # @## $$ #",
                "#    $      #",
                "#  $  ###   #",
                "### #####$###",
                "# $  ### ..#",
                "# $ $ $ ...#",
                "#    ###...#",
                "# $$ # #...#",
                "#  ### #####",
                "#### "
                ]
            },
            {
                name: "Level 8",
                layout: [
                "  ####",
                "  #  ###########",
                "  #    $   $ $ #",
                "  # $# $ #  $  #",
                "  #  $ $  #    #",
                "### $# #  #### #",
                "#@#$ $ $  ##   #",
                "#    $ #$#   # #",
                "#   $    $ $ $ #",
                "#####  #########",
                "  #      #",
                "  #      #",
                "  #......#",
                "  #......#",
                "  #......#",
                "  ######## "
                ]
            },
            {
                name: "Level 9",
                layout: [
                "          #######",
                "          #  ...#",
                "      #####  ...#",
                "      #      . .#",
                "      #  ##  ...#",
                "      ## ##  ...#",
                "     ### ########",
                "     # $$$ ##",
                " #####  $ $ #####",
                "##   #$ $   #   #",
                "#@ $  $    $  $ #",
                "###### $$ $ #####",
                "     #      #",
                "     ######## "
                ]
            },
            {
                name: "Level 10",
                layout: [
                " ###  #############",
                "##@####       #   #",
                "# $$   $$  $ $ ...#",
                "#  $$$#    $  #...#",
                "# $   # $$ $$ #...#",
                "###   #  $    #...#",
                "#     # $ $ $ #...#",
                "#    ###### ###...#",
                "## #  #  $ $  #...#",
                "#  ## # $$ $ $##..#",
                "# ..# #  $      #.#",
                "# ..# # $$$ $$$ #.#",
                "##### #       # #.#",
                "    # ######### #.#",
                "    #           #.#",
                "    ############### "
                ]
            },
            {
                name: "Level 11",
                layout: [
                "          ####",
                "     #### #  #",
                "   ### @###$ #",
                "  ##      $  #",
                " ##  $ $$## ##",
                " #  #$##     #",
                " # # $ $$ # ###",
                " #   $ #  # $ #####",
                "####    #  $$ #   #",
                "#### ## $         #",
                "#.    ###  ########",
                "#.. ..# ####",
                "#...#.#",
                "#.....#",
                "####### "
                ]
            },
            {
                name: "Level 12",
                layout: [
                "################",
                "#              #",
                "# # ######     #",
                "# #  $ $ $ $#  #",
                "# #   $@$   ## ##",
                "# #  $ $ $###...#",
                "# #   $ $  ##...#",
                "# ###$$$ $ ##...#",
                "#     # ## ##...#",
                "#####   ## ##...#",
                "    #####     ###",
                "        #     #",
                "        ####### "
                ]
            },
            {
                name: "Level 13",
                layout: [
                "   #########",
                "  ##   ##  ######",
                "###     #  #    ###",
                "#  $ #$ #  #  ... #",
                "# # $#@$## # #.#. #",
                "#  # #$  #    . . #",
                "# $    $ # # #.#. #",
                "#   ##  ##$ $ . . #",
                "# $ #   #  #$#.#. #",
                "## $  $   $  $... #",
                " #$ ######    ##  #",
                " #  #    ##########",
                " #### "
                ]
            },
            {
                name: "Level 14",
                layout: [
                "       #######",
                " #######     #",
                " #     # $@$ #",
                " #$$ #   #########",
                " # ###......##   #",
                " #   $......## # #",
                " # ###......     #",
                "##   #### ### #$##",
                "#  #$   #  $  # #",
                "#  $ $$$  # $## #",
                "#   $ $ ###$$ # #",
                "#####     $   # #",
                "    ### ###   # #",
                "      #     #   #",
                "      ########  #",
                "             #### "
                ]
            },
            {
                name: "Level 15",
                layout: [
                "   ########",
                "   #   #  #",
                "   #  $   #",
                " ### #$   ####",
                " #  $  ##$   #",
                " #  # @ $ # $#",
                " #  #      $ ####",
                " ## ####$##     #",
                " # $#.....# #   #",
                " #  $..**. $# ###",
                "##  #.....#   #",
                "#   ### #######",
                "# $$  #  #",
                "#  #     #",
                "######   #",
                "     ##### "
                ]
            },
            {
                name: "Level 16",
                layout: [
                "#####",
                "#   ##",
                "#    #  ####",
                "# $  ####  #",
                "#  $$ $   $#",
                "###@ #$    ##",
                " #  ##  $ $ ##",
                " # $  ## ## .#",
                " #  #$##$  #.#",
                " ###   $..##.#",
                "  #    #.*...#",
                "  # $$ #.....#",
                "  #  #########",
                "  #  #",
                "  #### "
                ]
            },
            {
                name: "Level 17",
                layout: [
                "   ##########",
                "   #..  #   #",
                "   #..      #",
                "   #..  #  ####",
                "  #######  #  ##",
                "  #            #",
                "  #  #  ##  #  #",
                "#### ##  #### ##",
                "#  $  ##### #  #",
                "# # $  $  # $  #",
                "# @$  $   #   ##",
                "#### ## #######",
                "   #    #",
                "   ###### "
                ]
            },
            {
                name: "Level 18",
                layout: [
                "     ###########",
                "     #  .  #   #",
                "     # #.    @ #",
                " ##### ##..# ####",
                "##  # ..###     ###",
                "# $ #...   $ #  $ #",
                "#    .. ##  ## ## #",
                "####$##$# $ #   # #",
                "  ## #    #$ $$ # #",
                "  #  $ # #  # $## #",
                "  #               #",
                "  #  ###########  #",
                "  ####         #### "
                ]
            },
            {
                name: "Level 19",
                layout: [
                "  ######",
                "  #   @####",
                "##### $   #",
                "#   ##    ####",
                "# $ #  ##    #",
                "# $ #  ##### #",
                "## $  $    # #",
                " # $ $ ### # #",
                " # #  $  # # #",
                " # # #$#   # #",
                "## ###   # # ######",
                "#  $  #### # #....#",
                "#    $    $   ..#.#",
                "####$  $# $   ....#",
                "#       #  ## ....#",
                "################### "
                ]
            },
            {
                name: "Level 20",
                layout: [
                "    ##########",
                "#####        ####",
                "#     #   $  #@ #",
                "# #######$####  ###",
                "# #    ## #  #$ ..#",
                "# # $     #  #  #.#",
                "# # $  #     #$ ..#",
                "# #  ### ##     #.#",
                "# ###  #  #  #$ ..#",
                "# #    #  ####  #.#",
                "# #$   $  $  #$ ..#",
                "#    $ # $ $ #  #.#",
                "#### $###    #$ ..#",
                "   #    $$ ###....#",
                "   #      ## ######",
                "   ######## "
                ]
            },
            {
                name: "Level 21",
                layout: [
                "#########",
                "#       #",
                "#       ####",
                "## #### #  #",
                "## #@##    #",
                "# $$$ $  $$#",
                "#  # ## $  #",
                "#  # ##  $ ####",
                "####  $$$ $#  #",
                " #   ##   ....#",
                " # #   # #.. .#",
                " #   # # ##...#",
                " ##### $  #...#",
                "     ##   #####",
                "      ##### "
                ]
            },
            {
                name: "Level 22",
                layout: [
                "######     ####",
                "#    #######  #####",
                "#   $#  #  $  #   #",
                "#  $  $  $ # $ $  #",
                "##$ $   # @# $    #",
                "#  $ ########### ##",
                "# #   #.......# $#",
                "# ##  # ......#  #",
                "# #   $........$ #",
                "# # $ #.... ..#  #",
                "#  $ $####$#### $#",
                "# $   ### $   $  ##",
                "# $     $ $  $    #",
                "## ###### $ ##### #",
                "#         #       #",
                "################### "
                ]
            },
            {
                name: "Level 23",
                layout: [
                "    #######",
                "    #  #  ####",
                "##### $#$ #  ##",
                "#.. #  #  #   #",
                "#.. # $#$ #  $####",
                "#.  #     #$  #  #",
                "#..   $#  # $    #",
                "#..@#  #$ #$  #  #",
                "#.. # $#     $#  #",
                "#.. #  #$$#$  #  ##",
                "#.. # $#  #  $#$  #",
                "#.. #  #  #   #   #",
                "##. ####  #####   #",
                " ####  ####   ##### "
                ]
            },
            {
                name: "Level 24",
                layout: [
                "###############",
                "#..........  .####",
                "#..........$$.#  #",
                "###########$ #   ##",
                "#      $  $     $ #",
                "## ####   #  $ #  #",
                "#      #   ##  # ##",
                "#  $#  # ##  ### ##",
                "# $ #$###    ### ##",
                "###  $ #  #  ### ##",
                "###    $ ## #  # ##",
                " # $  #  $  $ $   #",
                " #  $  $#$$$  #   #",
                " #  #  $      #####",
                " # @##  #  #  #",
                " ############## "
                ]
            },
            {
                name: "Level 25",
                layout: [
                "####",
                "#  ##############",
                "#  #   ..#......#",
                "#  # # ##### ...#",
                "##$#    ........#",
                "#   ##$######  ####",
                "# $ #     ######@ #",
                "##$ # $   ######  #",
                "#  $ #$$$##       #",
                "#      #    #$#$###",
                "# #### #$$$$$    #",
                "# #    $     #   #",
                "# #   ##        ###",
                "# ######$###### $ #",
                "#        #    #   #",
                "##########    ##### "
                ]
            },
            {
                name: "Level 26",
                layout: [
                " #######",
                " #  #  #####",
                "##  #  #...###",
                "#  $#  #...  #",
                "# $ #$$ ...  #",
                "#  $#  #... .#",
                "#   # $########",
                "##$       $ $ #",
                "##  #  $$ #   #",
                " ######  ##$$@#",
                "      #      ##",
                "      ######## "
                ]
            },
            {
                name: "Level 27",
                layout: [
                " #################",
                " #...   #    #   ##",
                "##.....  $## # #$ #",
                "#......#  $  #    #",
                "#......#  #  # #  #",
                "######### $  $ $  #",
                "  #     #$##$ ##$##",
                " ##   $    # $    #",
                " #  ## ### #  ##$ #",
                " # $ $$     $  $  #",
                " # $    $##$ ######",
                " #######  @ ##",
                "       ###### "
                ]
            },
            {
                name: "Level 28",
                layout: [
                "         #####",
                "     #####   #",
                "    ## $  $  ####",
                "##### $  $ $ ##.#",
                "#       $$  ##..#",
                "#  ###### ###.. #",
                "## #  #    #... #",
                "# $   #    #... #",
                "#@ #$ ## ####...#",
                "####  $ $$  ##..#",
                "   ##  $ $  $...#",
                "    # $$  $ #  .#",
                "    #   $ $  ####",
                "    ######   #",
                "         ##### "
                ]
            },
            {
                name: "Level 29",
                layout: [
                "#####",
                "#   ##",
                "# $  #########",
                "## # #       ######",
                "## #   $#$#@  #   #",
                "#  #      $ #   $ #",
                "#  ### ######### ##",
                "#  ## ..*..... # ##",
                "## ## *.*..*.* # ##",
                "# $########## ##$ #",
                "#  $   $  $    $  #",
                "#  #   #   #   #  #",
                "################### "
                ]
            },
            {
                name: "Level 30",
                layout: [
                "       ###########",
                "       #   #     #",
                "#####  #     $ $ #",
                "#   ##### $## # ##",
                "# $ ##   # ## $  #",
                "# $  @$$ # ##$$$ #",
                "## ###   # ##    #",
                "## #   ### #####$#",
                "## #     $  #....#",
                "#  ### ## $ #....##",
                "# $   $ #   #..$. #",
                "#  ## $ #  ##.... #",
                "#####   ######...##",
                "    #####    ##### "
                ]
            },
            {
                name: "Level 31",
                layout: [
                "  ####",
                "  #  #########",
                " ##  ##  #   #",
                " #  $# $@$   ####",
                " #$  $  # $ $#  ##",
                "##  $## #$ $     #",
                "#  #  # #   $$$  #",
                "# $    $  $## ####",
                "# $ $ #$#  #  #",
                "##  ###  ###$ #",
                " #  #....     #",
                " ####......####",
                "   #....####",
                "   #...##",
                "   #...#",
                "   ##### "
                ]
            },
            {
                name: "Level 32",
                layout: [
                "      ####",
                "  #####  #",
                " ##     $#",
                "## $  ## ###",
                "#@$ $ # $  #",
                "#### ##   $#",
                " #....#$ $ #",
                " #....#   $#",
                " #....  $$ ##",
                " #... # $   #",
                " ######$ $  #",
                "      #   ###",
                "      #$ ###",
                "      #  #",
                "      #### "
                ]
            },
            {
                name: "Level 33",
                layout: [
                "############",
                "##     ##  #",
                "##   $   $ #",
                "#### ## $$ #",
                "#   $ #    #",
                "# $$$ # ####",
                "#   # # $ ##",
                "#  #  #  $ #",
                "# $# $#    #",
                "#   ..# ####",
                "####.. $ #@#",
                "#.....# $# #",
                "##....#  $ #",
                "###..##    #",
                "############ "
                ]
            },
            {
                name: "Level 34",
                layout: [
                " #########",
                " #....   ##",
                " #.#.#  $ ##",
                "##....# # @##",
                "# ....#  #  ##",
                "#     #$ ##$ #",
                "## ###  $    #",
                " #$  $ $ $#  #",
                " # #  $ $ ## #",
                " #  ###  ##  #",
                " #    ## ## ##",
                " #  $ #  $  #",
                " ###$ $   ###",
                "   #  #####",
                "   #### "
                ]
            },
            {
                name: "Level 35",
                layout: [
                "############ ######",
                "#   #    # ###....#",
                "#   $$#   @  .....#",
                "#   # ###   # ....#",
                "## ## ###  #  ....#",
                " # $ $     # # ####",
                " #  $ $##  #      #",
                "#### #  #### # ## #",
                "#  # #$   ## #    #",
                "# $  $  # ## #   ##",
                "# # $ $    # #   #",
                "#  $ ## ## # #####",
                "# $$     $$  #",
                "## ## ### $  #",
                " #    # #    #",
                " ###### ###### "
                ]
            },
            {
                name: "Level 36",
                layout: [
                "            #####",
                "#####  ######   #",
                "#   ####  $ $ $ #",
                "# $   ## ## ##  ##",
                "#   $ $     $  $ #",
                "### $  ## ##     ##",
                "  # ##### #####$$ #",
                " ##$##### @##     #",
                " # $  ###$### $  ##",
                " # $  #   ###  ###",
                " # $$ $ #   $$ #",
                " #     #   ##  #",
                " #######.. .###",
                "    #.........#",
                "    #.........#",
                "    ########### "
                ]
            },
            {
                name: "Level 37",
                layout: [
                "###########",
                "#......   #########",
                "#......   #  ##   #",
                "#..### $    $     #",
                "#... $ $ #   ##   #",
                "#...#$#####    #  #",
                "###    #   #$  #$ #",
                "  #  $$ $ $  $##  #",
                "  #  $   #$#$ ##$ #",
                "  ### ## #    ##  #",
                "   #  $ $ ## ######",
                "   #    $  $  #",
                "   ##   # #   #",
                "    #####@#####",
                "        ### "
                ]
            },
            {
                name: "Level 38",
                layout: [
                "      ####",
                "####### @#",
                "#     $  #",
                "#   $## $#",
                "##$#...# #",
                " # $...  #",
                " # #. .# ##",
                " #   # #$ #",
                " #$  $    #",
                " #  #######",
                " #### "
                ]
            },
            {
                name: "Level 39",
                layout: [
                "             ######",
                " #############....#",
                "##   ##     ##....#",
                "#  $$##  $ @##....#",
                "#      $$ $#  ....#",
                "#  $ ## $$ # # ...#",
                "#  $ ## $  #  ....#",
                "## ##### ### ##.###",
                "##   $  $ ##   .  #",
                "# $###  # ##### ###",
                "#   $   #       #",
                "#  $ #$ $ $###  #",
                "# $$$# $   # ####",
                "#    #  $$ #",
                "######   ###",
                "     ##### "
                ]
            },
            {
                name: "Level 40",
                layout: [
                "    ############",
                "    #          ##",
                "    #  # #$$ $  #",
                "    #$ #$#  ## @#",
                "   ## ## # $ # ##",
                "   #   $ #$  # #",
                "   #   # $   # #",
                "   ## $ $   ## #",
                "   #  #  ##  $ #",
                "   #    ## $$# #",
                "######$$   #   #",
                "#....#  ########",
                "#.#... ##",
                "#....   #",
                "#....   #",
                "######### "
                ]
            },
            {
                name: "Level 41",
                layout: [
                "           #####",
                "          ##   ##",
                "         ##     #",
                "        ##  $$  #",
                "       ## $$  $ #",
                "       # $    $ #",
                "####   #   $$ #####",
                "#  ######## ##    #",
                "#.            $$$@#",
                "#.# ####### ##   ##",
                "#.# #######. #$ $##",
                "#........... #    #",
                "##############  $ #",
                "             ##  ##",
                "              #### "
                ]
            },
            {
                name: "Level 42",
                layout: [
                "     ########",
                "  ####      ######",
                "  #    ## $ $   @#",
                "  # ## ##$#$ $ $##",
                "### ......#  $$ ##",
                "#   ......#  #   #",
                "# # ......#$  $  #",
                "# #$...... $$# $ #",
                "#   ### ###$  $ ##",
                "###  $  $  $  $ #",
                "  #  $  $  $  $ #",
                "  ######   ######",
                "       ##### "
                ]
            },
            {
                name: "Level 43",
                layout: [
                "        #######",
                "    #####  #  ####",
                "    #   #   $    #",
                " #### #$$ ## ##  #",
                "##      # #  ## ###",
                "#  ### $#$  $  $  #",
                "#...    # ##  #   #",
                "#...#    @ # ### ##",
                "#...#  ###  $  $  #",
                "######## ##   #   #",
                "          ######### "
                ]
            },
            {
                name: "Level 44",
                layout: [
                " #####",
                " #   #",
                " # # #######",
                " #      $@######",
                " # $ ##$ ###   #",
                " # #### $    $ #",
                " # ##### #  #$ ####",
                "##  #### ##$      #",
                "#  $#  $  # ## ## #",
                "#         # #...# #",
                "######  ###  ...  #",
                "     #### # #...# #",
                "          # ### # #",
                "          #       #",
                "          ######### "
                ]
            },
            {
                name: "Level 45",
                layout: [
                "##### ####",
                "#...# #  ####",
                "#...###  $  #",
                "#....## $  $###",
                "##....##   $  #",
                "###... ## $ $ #",
                "# ##    #  $  #",
                "#  ## # ### ####",
                "# $ # #$  $    #",
                "#  $ @ $    $  #",
                "#   # $ $$ $ ###",
                "#  ######  ###",
                "# ##    ####",
                "### "
                ]
            },
            {
                name: "Level 46",
                layout: [
                "##########",
                "#        ####",
                "# ###### #  ##",
                "# # $ $ $  $ #",
                "#       #$   #",
                "###$  $$#  ###",
                "  #  ## # $##",
                "  ##$#   $ @#",
                "   #  $ $ ###",
                "   # #   $  #",
                "   # ##   # #",
                "  ##  ##### #",
                "  #         #",
                "  #.......###",
                "  #.......#",
                "  ######### "
                ]
            },
            {
                name: "Level 47",
                layout: [
                "         ####",
                " #########  ##",
                "##  $      $ #####",
                "#   ## ##   ##...#",
                "# #$$ $ $$#$##...#",
                "# #   @   #   ...#",
                "#  $# ###$$   ...#",
                "# $  $$  $ ##....#",
                "###$       #######",
                "  #  #######",
                "  #### "
                ]
            },
            {
                name: "Level 48",
                layout: [
                "  #########",
                "  #*.*#*.*#",
                "  #.*.*.*.#",
                "  #*.*.*.*#",
                "  #.*.*.*.#",
                "  #*.*.*.*#",
                "  ###   ###",
                "    #   #",
                "###### ######",
                "#           #",
                "# $ $ $ $ $ #",
                "## $ $ $ $ ##",
                " #$ $ $ $ $#",
                " #   $@$   #",
                " #  #####  #",
                " ####   #### "
                ]
            },
            {
                name: "Level 49",
                layout: [
                "       ####",
                "       #  ##",
                "       #   ##",
                "       # $$ ##",
                "     ###$  $ ##",
                "  ####    $   #",
                "###  # #####  #",
                "#    # #....$ #",
                "# #   $ ....# #",
                "#  $ # #.*..# #",
                "###  #### ### #",
                "  #### @$  ##$##",
                "     ### $     #",
                "       #  ##   #",
                "       ######### "
                ]
            },
            {
                name: "Level 50",
                layout: [
                "      ############",
                "     ##..    #   #",
                "    ##..* $    $ #",
                "   ##..*.# # # $##",
                "   #..*.# # # $  #",
                "####...#  #    # #",
                "#  ## #          #",
                "# @$ $ ###  #   ##",
                "# $   $   # #   #",
                "###$$   # # # # #",
                "  #   $   # # #####",
                "  # $# #####      #",
                "  #$   #   #    # #",
                "  #  ###   ##     #",
                "  #  #      #    ##",
                "  ####      ###### "
                ]
            },
            {
                name: "Classic 4: Enclosure (Original #2 - Fixed)", // 3 boxes, 3 targets
                layout: [
                    "    #####",
                    "    #   #",
                    "    #   #",
                    "  ###$###",
                    "  #@$.$ #",
                    "  ### $ #",
                    "  # . . #",
                    "    #####"
                ]
            },
            {
                name: "Microban I: Level 1", // 1 box, 3 targets
                layout: [
                    " ######",
                    " # .. #",
                    " # $*@#",
                    " #    #",
                    " ######"
                ]
            },
            {
                name: "Microban I: Level 2", // 3 boxes, 3 targets
                layout: [
                    "  ####",
                    " ## .#",
                    "##$* #",
                    "#@$ .#",
                    "#  ###",
                    "####"
                ]
            },
            {
                name: "Classic 5: Open Push (Original #5)", // 2 boxes, 2 targets
                layout: [
                    "  #######",
                    "  #     #",
                    "  #  $  #",
                    "  # .@. #",
                    "  #  $  #",
                    "  #     #",
                    "  #######"
                ]
            },
            {
                name: "Classic 6: Symmetric (Original #30)", // 6 boxes, 6 targets
                layout: [
                    "    ######",
                    "    #    #",
                    "    # $  #",
                    "  ###$.$##",
                    "  # $.@.$#",
                    "  ##$.$ ###",
                    "   # $  #",
                    "   #    #",
                    "   ######"
                ]
            },
            {
                name: "Classic 7: Original #10", // 4 boxes, 4 targets.
                layout: [
                    "  ####",
                    "  # .#",
                    "  #  ###",
                    " ##$@$.#",
                    " #  $$.#",
                    " # # ..#",
                    " #   ###",
                    " #####"
                ]
            },
            {
                name: "Microban II - Level 1", // 2 boxes, 2 targets
                layout: [
                    "   ####",
                    "####  #",
                    "#@ $$.#",
                    "####  #",
                    "   ####"
                ]
            }
        ];


        // --- Game Element Characters ---
        const WALL = '#';
        const FLOOR = ' ';
        const PLAYER = '@';
        const PLAYER_ON_TARGET = '+';
        const BOX = '$';
        const BOX_ON_TARGET = '*';
        const TARGET = '.';

        // --- Game State ---
        let currentLevelIndex = 0;
        let currentBoard = [];
        let playerPos = { r: 0, c: 0 };
        let numBoxesToWin = 0;
        let moveHistory = [];
        let moveCount = 0;

        // --- DOM Elements ---
        const gameBoardElement = document.getElementById('gameBoard');
        const levelSelectElement = document.getElementById('levelSelect');
        const resetButton = document.getElementById('resetButton');
        const undoButton = document.getElementById('undoButton');
        const messageElement = document.getElementById('message');
        const moveCounterElement = document.getElementById('moveCounter');
        // D-Pad Buttons
        const dpadUpButton = document.getElementById('dpadUp');
        const dpadDownButton = document.getElementById('dpadDown');
        const dpadLeftButton = document.getElementById('dpadLeft');
        const dpadRightButton = document.getElementById('dpadRight');


        // --- Helper Functions ---
        function deepCopyBoard(board) {
            return board.map(row => row.slice());
        }

        function getCellChar(r, c) {
            if (r < 0 || r >= currentBoard.length || !currentBoard[r] || c < 0 || c >= currentBoard[r].length) {
                return WALL;
            }
            return currentBoard[r][c];
        }

        function setCellChar(r, c, char) {
            if (r >= 0 && r < currentBoard.length && currentBoard[r] && c >= 0 && c < currentBoard[r].length) {
                currentBoard[r][c] = char;
            }
        }

        function updateMoveCounterDisplay() {
            if (moveCounterElement) {
                moveCounterElement.textContent = `Moves: ${moveCount}`;
            }
        }

        // --- Game Logic ---
        function populateLevelSelector() {
            levelSelectElement.innerHTML = '';
            levels.forEach((level, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = level.name;
                levelSelectElement.appendChild(option);
            });
            levelSelectElement.value = currentLevelIndex;
        }

        function loadLevel(levelIndex) {
            currentLevelIndex = parseInt(levelIndex);
            const levelData = levels[currentLevelIndex].layout;

            let maxWidth = 0;
            levelData.forEach(row => {
                if (row.length > maxWidth) maxWidth = row.length;
            });

            currentBoard = levelData.map(rowStr => rowStr.padEnd(maxWidth, ' ').split(''));

            moveHistory = [];
            numBoxesToWin = 0;
            moveCount = 0;
            messageElement.textContent = "Use arrow keys, W/A/S/D, or on-screen D-pad to move.";

            for (let r = 0; r < currentBoard.length; r++) {
                for (let c = 0; c < currentBoard[r].length; c++) {
                    const charFromLayout = currentBoard[r][c];

                    if (charFromLayout === PLAYER || charFromLayout === PLAYER_ON_TARGET) {
                        playerPos = { r, c };
                    }
                    if (charFromLayout === BOX || charFromLayout === BOX_ON_TARGET) {
                        numBoxesToWin++;
                    }

                    if (charFromLayout === PLAYER) currentBoard[r][c] = FLOOR;
                    else if (charFromLayout === PLAYER_ON_TARGET) currentBoard[r][c] = TARGET;
                }
            }
            renderBoard();
        }

        function renderBoard() {
            gameBoardElement.innerHTML = '';
            if (!currentBoard.length || !currentBoard[0].length) return;

            gameBoardElement.style.gridTemplateRows = `repeat(${currentBoard.length}, 30px)`;
            gameBoardElement.style.gridTemplateColumns = `repeat(${currentBoard[0].length}, 30px)`;

            let currentBoxesOnTarget = 0;

            for (let r = 0; r < currentBoard.length; r++) {
                for (let c = 0; c < currentBoard[r].length; c++) {
                    const cellDiv = document.createElement('div');
                    cellDiv.classList.add('cell');
                    const boardChar = currentBoard[r][c];
                    let displayCharSymbol = '';

                    if (playerPos.r === r && playerPos.c === c) {
                        displayCharSymbol = '☺';
                        if (boardChar === TARGET) {
                            cellDiv.classList.add('player-on-target');
                        } else {
                            cellDiv.classList.add('player');
                        }
                    } else {
                        switch (boardChar) {
                            case WALL: cellDiv.classList.add('wall'); displayCharSymbol = '█'; break;
                            case FLOOR: cellDiv.classList.add('floor'); displayCharSymbol = ' '; break;
                            case BOX: cellDiv.classList.add('box'); displayCharSymbol = '■'; break;
                            case BOX_ON_TARGET:
                                cellDiv.classList.add('box-on-target');
                                displayCharSymbol = '■';
                                currentBoxesOnTarget++;
                                break;
                            case TARGET: cellDiv.classList.add('target'); displayCharSymbol = '·'; break;
                            default: cellDiv.classList.add('floor'); displayCharSymbol = ' ';
                        }
                    }
                    cellDiv.textContent = displayCharSymbol;
                    gameBoardElement.appendChild(cellDiv);
                }
            }
            updateMoveCounterDisplay();
            checkWinCondition(currentBoxesOnTarget);
        }

        function movePlayer(dr, dc) {
            if (isGameWon()) return;

            const newPlayerR = playerPos.r + dr;
            const newPlayerC = playerPos.c + dc;
            const targetCellBoardChar = getCellChar(newPlayerR, newPlayerC);

            if (targetCellBoardChar === WALL) return;

            moveHistory.push({
                board: deepCopyBoard(currentBoard),
                playerPos: { ...playerPos }
            });
            if (moveHistory.length > 50) moveHistory.shift();

            let actualMoveMade = false;

            if (targetCellBoardChar === BOX || targetCellBoardChar === BOX_ON_TARGET) {
                const newBoxR = newPlayerR + dr;
                const newBoxC = newPlayerC + dc;
                const cellBeyondBoxBoardChar = getCellChar(newBoxR, newBoxC);

                if (cellBeyondBoxBoardChar === FLOOR || cellBeyondBoxBoardChar === TARGET) {
                    setCellChar(newBoxR, newBoxC, cellBeyondBoxBoardChar === TARGET ? BOX_ON_TARGET : BOX);
                    setCellChar(newPlayerR, newPlayerC, targetCellBoardChar === BOX_ON_TARGET ? TARGET : FLOOR);
                    playerPos = { r: newPlayerR, c: newPlayerC };
                    actualMoveMade = true;
                } else {
                    moveHistory.pop();
                    return;
                }
            } else {
                playerPos = { r: newPlayerR, c: newPlayerC };
                actualMoveMade = true;
            }

            if (actualMoveMade) {
                moveCount++;
            }
            renderBoard();
        }

        function checkWinCondition(currentBoxesOnTarget) {
            if (numBoxesToWin > 0 && currentBoxesOnTarget === numBoxesToWin) {
                messageElement.textContent = `Level ${currentLevelIndex + 1} Complete! Moves: ${moveCount}. Congratulations!`;
            } else if (messageElement.textContent.startsWith("Level")) {
                messageElement.textContent = "Use arrow keys, W/A/S/D, or on-screen D-pad to move.";
            }
        }

        function isGameWon() {
            let count = 0;
            if (!currentBoard.length) return false;
            for (let r = 0; r < currentBoard.length; r++) {
                for (let c = 0; c < currentBoard[r].length; c++) {
                    if (currentBoard[r][c] === BOX_ON_TARGET) {
                        count++;
                    }
                }
            }
            return numBoxesToWin > 0 && count === numBoxesToWin;
        }

        function undoMove() {
            if (isGameWon() && moveHistory.length > 0) {
                messageElement.textContent = "Move undone.";
            }
            if (moveHistory.length > 0) {
                const prevState = moveHistory.pop();
                currentBoard = prevState.board;
                playerPos = prevState.playerPos;

                if (moveCount > 0) {
                    moveCount--;
                }

                if (!isGameWon() && !messageElement.textContent.startsWith("Level reset")) {
                     messageElement.textContent = "Move undone.";
                }
                renderBoard();
            } else {
                if (!messageElement.textContent.startsWith("Level")) {
                    messageElement.textContent = "No moves to undo.";
                }
            }
        }

        // --- Event Listeners ---
        levelSelectElement.addEventListener('change', (e) => {
            loadLevel(e.target.value);
        });

        resetButton.addEventListener('click', () => {
            messageElement.textContent = "Level reset.";
            loadLevel(currentLevelIndex);
        });

        undoButton.addEventListener('click', undoMove);

        document.addEventListener('keydown', (e) => {
            if (["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight", "w", "a", "s", "d", "W", "A", "S", "D"].includes(e.key)) {
                e.preventDefault(); // Prevent page scroll for these keys
            }
            switch (e.key.toLowerCase()) {
                case 'arrowup': case 'w': movePlayer(-1, 0); break;
                case 'arrowdown': case 's': movePlayer(1, 0); break;
                case 'arrowleft': case 'a': movePlayer(0, -1); break;
                case 'arrowright': case 'd': movePlayer(0, 1); break;
            }
        });

        // D-Pad Event Listeners
        if(dpadUpButton) dpadUpButton.addEventListener('click', () => movePlayer(-1, 0));
        if(dpadDownButton) dpadDownButton.addEventListener('click', () => movePlayer(1, 0));
        if(dpadLeftButton) dpadLeftButton.addEventListener('click', () => movePlayer(0, -1));
        if(dpadRightButton) dpadRightButton.addEventListener('click', () => movePlayer(0, 1));


        // --- Initialization ---
        populateLevelSelector();
        loadLevel(currentLevelIndex);
    </script>
</body>
</html>
